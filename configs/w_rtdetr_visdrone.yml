# W-RT-DETR VisDrone Configuration
# [完整修复版]
# 1. 包含防爆设置 (Clip Norm, Low LR)
# 2. [补回] PostProcessor 配置 (解决 NoneType 报错)

__include__: [
  'visdrone_detection.yml',
  'runtime.yml',
]

output_dir: ./output/w_rtdetr_visdrone_final

# --- 模型架构 ---
model:
  type: WRTDETR
  backbone_depth: 50
  num_classes: 10
  hidden_dim: 256
  num_queries: 300

# --- 损失函数 & 匹配器 ---
criterion:
  type: SetCriterion
  weight_dict: {loss_vfl: 1, loss_bbox: 5, loss_nwd: 1}
  losses: ['vfl', 'boxes', 'nwd']
  matcher:
    type: FrequencySinkhornMatcher
    cost_class: 2.0
    cost_bbox: 5.0
    cost_nwd: 5.0
    iter_steps: 20

# --- [补回] 后处理器 (之前漏了这里) ---
postprocessor:
  type: RTDETRPostProcessor
  num_classes: 10
  use_focal_loss: True
  num_top_queries: 300

# --- 优化器 ---
optimizer:
  type: AdamW
  params:
    -
      params: '^(?=.*backbone)(?!.*norm).*$'
      lr: 0.00001
    -
      params: '^(?=.*encoder|decoder|query_selector)(?!.*norm).*$'
      lr: 0.00005 # 保持低学习率求稳
  weight_decay: 0.0001

# --- 梯度裁剪 ---
clip_max_norm: 0.1

lr_scheduler:
  type: CosineAnnealingLR
  T_max: 72
  eta_min: 0.0

# --- 数据加载 ---
train_dataloader:
  dataset:
    transforms:
      ops:
        - {type: RandomPhotometricDistort, p: 0.5}
        - {type: RandomZoomOut, fill: 0}
        # - {type: RandomIoUCrop, p: 0.8} # 保持关闭
        - {type: SanitizeBoundingBox, min_size: 1}
        - {type: RandomHorizontalFlip}
        - {type: Resize, size: [640, 640]}
        - {type: ConvertBox, out_fmt: 'cxcywh', normalize: True}
        - {type: ToImageTensor}
        - {type: ConvertDtype}

# --- EMA ---
ema:
  decay: 0.9999
  warmups: 2000

epoches: 72