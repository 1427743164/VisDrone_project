# W-RT-DETR VisDrone Configuration
# 核心策略：
# 1. 优化器：AdamW + Cosine Annealing
# 2. 数据增强：VisDrone 目标太密，关闭 Mosaic 这种强烈的拼图增强，防止小目标被截断
# 3. Loss：启用 NWD Loss

__include__: [
  '../dataset/visdrone_detection.yml',
  '../runtime.yml',
  './include/dataloader.yml',
  './include/optimizer.yml',
]

output_dir: ./output/w_rtdetr_visdrone_final

# --- 模型架构定义 ---
model:
  type: WRTDETR # 对应 models/w_rtdetr.py 中的类名
  backbone_depth: 50
  num_classes: 10 # VisDrone 有 10 类
  hidden_dim: 256
  num_queries: 300 # 可以尝试增加到 500 如果显存允许

# --- 损失函数 & 匹配器 ---
criterion:
  type: SetCriterion
  weight_dict: {loss_vfl: 1, loss_bbox: 5, loss_nwd: 2} # 启用 loss_nwd
  losses: ['vfl', 'boxes', 'nwd'] # 注册 nwd
  matcher:
    type: FrequencySinkhornMatcher # 对应 models/matchers/freq_sinkhorn_matcher.py
    cost_class: 2.0
    cost_bbox: 5.0
    cost_nwd: 5.0
    iter_steps: 20

# --- 训练超参数 ---
optimizer:
  type: AdamW
  params:
    -
      params: '^(?=.*backbone)(?!.*norm).*$'
      lr: 0.00001 # Backbone 学习率更低
    -
      params: '^(?=.*encoder|decoder|query_selector)(?!.*norm).*$'
      lr: 0.0001  # 新模块学习率正常
  weight_decay: 0.0001

lr_scheduler:
  type: CosineAnnealingLR
  T_max: 72 # 72 epochs
  eta_min: 0.0

# --- 数据加载 ---
# 关键修改：VisDrone 不要用 Mosaic，改用简单的 RandomResize
train_dataloader:
  dataset:
    transforms:
      ops:
        - {type: RandomPhotometricDistort, p: 0.5}
        - {type: RandomZoomOut, fill: 0}
        - {type: RandomIoUCrop, p: 0.8}
        - {type: SanitizeBoundingBox, min_size: 1}
        - {type: RandomHorizontalFlip}
        - {type: Resize, size: [640, 640]}
        # 移除了 Mosaic 和 Mixup，这对 VisDrone 这种密集数据集通常有负面效果

epoches: 72 # VisDrone 72 epoch 足够收敛